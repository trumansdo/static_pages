<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>伤寒论涉及药材图片浏览器</title>
    <!-- 引入样式 -->
    <link
      href="https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.bootcdn.net/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- 图片画廊 -->
    <div
      id="my-gallery"
      itemscope
      itemtype="http://schema.org/ImageGallery"
    ></div>

    <script src="data/ym_data.js"></script>
    <script src="data/url_data.js"></script>
    <script src="data/figure_data.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/device.js/0.2.7/device.js"></script>
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.1/vconsole.min.js"></script> -->
    <script type="module">
      //   let vConsole = new window.VConsole();
      const queryString = new URLSearchParams(window.location.search);

      let ym_source = queryString.get("ym_source");
      if (!queryString.has("ym_source")) {
        ym_source = "1";
      }
      let ym_arr = [];
      if (ym_source == "1") {
        // 仅伤寒论药材
        ym_arr = random_only_nihaixia_shl_ym_ext();
      } else if (ym_source == "2") {
        // 仅金匮的药材
        ym_arr = random_only_nihaixia_jk_ym_ext();
      } else if (ym_source == "3") {
        // 伤寒与金匮的
        // 神农本草经全部的
        ym_arr = random_nihaixia_shl_and_jk_ym_ext();
      } else if (ym_source == "0") {
        // 神农本草经全部的
        ym_arr = random_all_nihaixia_slbcj_ym_ext();
      } else if (ym_source == "4") {
        // 神农本草经中排除伤寒之外的药材
        ym_arr = random_exclude_nihaixia_shl_ym_ext();
      } else {
        // 全部
        ym_arr = [random_one_dir()];
      }

      let path_source = queryString.get("path_source");

      if (!queryString.has("path_source")) {
        path_source = "1";
      }

      let files = [];
      if (path_source == "1") {
        // 全部分文件路径，包括伪品的
        files = find_paths(ym_arr);
      } else {
        // 只包括正品的文件路径
        files = find_genuine_paths(ym_arr);
      }

      // 以下是生成图片浏览画廊的
      if (files === undefined || files.length === 0) {
        console.log("随机药名没有对应的图片文件: ", ym_arr);
        location.reload();
      }

      const gallery = document.getElementById("my-gallery");
      const pageWidth = window.innerWidth;

      files.forEach((path, index) => {
        const whole_path = "figure/" + path;
        const originalWidth = 0;
        const originalHeight = 0;
        const displayWidth = device.mobile()
          ? pageWidth
          : Math.min(originalWidth, pageWidth);
        const displayHeight = (originalHeight / originalWidth) * displayWidth;
        // 创建 DOM 元素
        const gallery_item_div = document.createElement("div");
        gallery_item_div.className = "pswp-gallery__item";
        {
          const link = document.createElement("a");
          link.href = "javascript:void(0)";
          link.setAttribute("data-pswp-src", whole_path);
          link.setAttribute("data-pswp-width", displayWidth);
          link.setAttribute("data-pswp-height", Math.round(displayHeight));
          link.target = "_blank";
          {
            const imageElement = document.createElement("img");
            imageElement.src = whole_path;
            imageElement.alt = ym_arr.join("|");
            imageElement.width = displayWidth;
            imageElement.height = Math.round(displayHeight);
            imageElement.style.width = displayWidth + "px";
            imageElement.style.height = Math.round(displayHeight) + "px";

            link.appendChild(imageElement);
          }
          gallery_item_div.appendChild(link);

          const captionDiv = document.createElement("div");
          captionDiv.className = "pswp-caption-content";
          captionDiv.textContent = path
            .split("/")
            .slice(1, 2)
            .join("")
            .split(".")[0];
          gallery_item_div.appendChild(captionDiv);
        }
        gallery.appendChild(gallery_item_div);
      });

      function waitForAllImages(callback) {
        const images = document.querySelectorAll("img");
        let loadedCount = 0;

        function checkLoaded() {
          loadedCount++;
          if (loadedCount === images.length) {
            callback(); // 所有图片加载完成后执行回调
          }
        }

        images.forEach((img) => {
          if (img.complete) {
            // 图片已缓存，直接计数
            loadedCount++;
          } else {
            // 监听加载完成或错误事件
            img.addEventListener("load", checkLoaded);
            img.addEventListener("error", checkLoaded); // 可选：处理加载失败
          }
        });

        // 如果所有图片已加载（例如缓存命中），直接触发回调
        if (loadedCount === images.length) {
          callback();
        }
      }

      // 使用示例
      waitForAllImages(() => {
        console.log("所有图片已加载完成，执行后续代码");
        // 调整图片宽高
        document.querySelectorAll(".pswp-gallery__item").forEach((item) => {
          const img = item.querySelector("img");

          const originalWidth = img.naturalWidth;
          const originalHeight = img.naturalHeight;
          // 移动端页面宽度为100%，非移动端页面宽度为80%
          const displayWidth = device.mobile() ? pageWidth : pageWidth * 0.8;
          // 保持图片的宽高比不变，根据宽度计算
          const displayHeight = (originalHeight / originalWidth) * displayWidth;

          // 处理img标签的属性
          img.width = displayWidth;
          img.height = Math.round(displayHeight);
          img.style.width = displayWidth + "px";
          img.style.height = Math.round(displayHeight) + "px";

          // 处理a标签的属性
          const a = item.querySelector("a");
          a.setAttribute("data-pswp-width", displayWidth);
          a.setAttribute("data-pswp-height", Math.round(displayHeight));
        });

        // 初始化 PhotoSwipe
        import(
          "https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe-lightbox.esm.js "
        ).then((module) => {
          const PhotoSwipeLightbox = module.default;
          const lightbox = new PhotoSwipeLightbox({
            gallery: "#my-gallery",
            childSelector: ".pswp-gallery__item",
            pswpModule: () =>
              import(
                "https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe.esm.js "
              ),
            initialZoomLevel: "fit",
            secondaryZoomLevel: 1,
            maxZoomLevel: 10,
            spacing: 0,
            allowPanToNext: true,
            wheelToZoom: true,
            pinchToClose: true,
            closeOnVerticalDrag: true,
          });

          import(
            "https://cdn.bootcdn.net/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.esm.js "
          ).then((pluginModule) => {
            const PhotoSwipeDynamicCaption = pluginModule.default;
            const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
              mobileLayoutBreakpoint: 700,
              type: "below",
              mobileCaptionOverlapRatio: 1,
            });

            lightbox.init();
          });
        });
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoSwipe 示例</title>
    <!-- 引入样式 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe.css" rel="stylesheet">
    <link
        href="https://cdn.bootcdn.net/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.css"
        rel="stylesheet">
</head>

<body>
    <!-- 图片画廊 -->
    <div id="my-gallery" itemscope itemtype="http://schema.org/ImageGallery">

    </div>

    <script src="data/vars.js"></script>
    <script src="data/figure_data.js"></script>

    <script type="module">
        let file_paths = source_file_paths;
        let ym_arr = shl_ym_zh_yyys_ext;
        let random_ym_arr = shl_ym_zh_yyys_ext[Math.floor(Math.random() * shl_ym_zh_yyys_ext.length)];

        const matched_ym = random_ym_arr.find(key => key in file_paths);
        const files = file_paths[matched_ym];
        if (files === undefined) {
            location.reload();
        }
        // 获取目标容器
        const gallery = document.getElementById("my-gallery");
        const pageWidth = window.innerWidth;  // 获取当前页面的宽度 [[3]]

        files.forEach(path => {
            const whole_path = "figure/" + path;
            const img = new Image();
            img.src = whole_path;

            img.onload = function () {
                const originalWidth = img.naturalWidth;   // 获取图片原始宽度 [[1]]
                const originalHeight = img.naturalHeight; // 获取图片原始高度 [[6]]

                // 计算调整后的宽度和高度（保持宽高比）
                const displayWidth = Math.min(originalWidth, pageWidth);
                const displayHeight = (originalHeight / originalWidth) * displayWidth;

                // 创建 div 元素
                const gallery_item_div = document.createElement("div");

                // 为 div 添加 class 属性
                gallery_item_div.className = "pswp-gallery__item";

                {
                    // 创建 <a> 标签
                    const link = document.createElement("a");
                    link.href = "javascript:void(0)";
                    link.setAttribute("data-pswp-src", whole_path);
                    link.setAttribute("data-pswp-width", displayWidth);  // 获取原始宽度
                    link.setAttribute("data-pswp-height", Math.round(displayHeight)); // 获取原始高度
                    link.target = "_blank";

                    // 创建并添加 <img> 标签
                    const imageElement = document.createElement("img");
                    imageElement.src = whole_path;
                    imageElement.alt = matched_ym;

                    imageElement.width = displayWidth;         // 设置 width 属性
                    imageElement.height = Math.round(displayHeight); // 设置 height 属性

                    // 或者使用 style 方式（也可以两者都加）
                    imageElement.style.width = displayWidth + 'px';
                    imageElement.style.height = Math.round(displayHeight) + 'px';

                    link.appendChild(imageElement);
                    gallery_item_div.appendChild(link);
                }
                {

                    // 创建 div 元素
                    const captionDiv = document.createElement("div");

                    // 为 div 添加 class 属性
                    captionDiv.className = "pswp-caption-content";

                    // 设置 div 的文本内容
                    captionDiv.textContent = path.split("/").slice(1, 2).join("").split(".")[0];
                    gallery_item_div.appendChild(captionDiv);
                }

                // 插入到目标容器中
                gallery.appendChild(gallery_item_div);
            };

            img.onerror = function () {
                console.error("图片加载失败:", path);
            };
        });

        import PhotoSwipeLightbox from 'https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe-lightbox.esm.js';
        import PhotoSwipeDynamicCaption from 'https://cdn.bootcdn.net/ajax/libs/photoswipe-dynamic-caption-plugin/1.2.7/photoswipe-dynamic-caption-plugin.esm.js';

        const lightbox = new PhotoSwipeLightbox({
            gallery: '#my-gallery',
            childSelector: '.pswp-gallery__item',
            pswpModule: () => import('https://cdn.bootcdn.net/ajax/libs/photoswipe/5.4.4/photoswipe.esm.js'),
            initialZoomLevel: 'fit',
            secondaryZoomLevel: 1,
            maxZoomLevel: 10,
        });
        const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
            mobileLayoutBreakpoint: 700,
            type: 'below',
            mobileCaptionOverlapRatio: 1
        });
        lightbox.init();
    </script>

</body>

</html>